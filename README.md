# Springboot AppStack [Cloudone Catalog]

**Springboot Cloudone** AppStack is toolkit and CI/CD workflow to develop, build and deploy springboot based API service for a Cloudone Applications.

This repository was generated by Cloudone provisioning automation for your application.

## Repository Directory Structure

- **source**  
_source_ directory contains maven project structure pre-configured with springboot.
- **helm_tempate directory**  
typically named with naming convntion appCode_Service. [Helm Templates](https://helm.sh/docs/) stored under this directory.
- **azure-pipeline.yml**  
Build pipeline definition
- **testrunner.ps1**  
Scripts provided to validate build and test of this service in developer local device.

## Frequently Asked Questions

### How to update springboot version

Update Springboot version propety in maven @[**source/pom.xml**](source/pom.xml)

```xml
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>2.1.4.RELEASE</version>
</parent>
```

### Change the version JDK

#### Step 1

Update builderImage variable [azure-pipeline.yml](azure-pipeline.yml) pointing to appropriate JDK version.

```yaml
variables:
- name: 'builderImage'
  value: 'openjdk/openjdk-11-rhel7:1.0'}
```

Consult [Redhat Container Catalog](https://access.redhat.com/containers/) for appropriate JDK S2I builder

#### Step 2

Update java.version property in maven @[**source/pom.xml**](source/pom.xml)

```xml
<java.version>11</java.version>
```

### Logging

Springboot AppStack is pre-configured for splunk log aggregation. Springboot Stdout and Tomcat access log is tagged with app_log and common_log source type. Refer chart-dir/tmpleates/deployment.yaml

```yaml
metadata:
    annotations:
        collectord.io/index: "app" #Three letter app code
        collectord.io/logs-source: "/var/log/springboot.out"
        collectord.io/logs-type: "app_log"
        collectord.io/logs-extraction: '^\[(?P<timestamp>[^\]]+)\].+$'
        collectord.io/logs-timestampfield: timestamp
        collectord.io/logs-timestampformat: '2019-06-03 05:41:49.598'
        collectord.io/logs-eventpattern: '^\['
        collectord.io/volume.1-logs-name: 'logs'
        collectord.io/volume.1-logs-index: "app" #Three letter app code
        collectord.io/volume.1-logs-type: 'access_common'
    spec:
        template:
            spec:
            volumes:
            - name: logs
                emptyDir: {}  
            containers:
            - name: "chart-name"
                env:
                - name: ACCESS_LOG
                value: /var/log/access
                volumeMounts:
                - name: logs
                mountPath: /var/log/access
```

Refer applicartion.yaml for log pattern

```yaml
server:
  tomcat: 
    accesslog:
      directory: '${ACCESS_LOG::/tmp/access}'
      enabled: true
      rotate: false

logging:
  pattern:
    console: '[%date{ISO8601}] logLevel=%level pid=${PID:-} thread=%thread class=%logger{40} message="%msg"%n'
```

Log pattern can be extended for additional fields by using key=value inserted before message field
